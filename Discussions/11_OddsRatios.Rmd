---
title: "Odds Ratios"
author: "Randy Johnson"
date: "3/9/2017"
output: beamer_presentation
header-includes:
  \usepackage{tikz}
  \usetikzlibrary{shapes,backgrounds}
  \usepackage{multicol}
  \usepackage{cancel}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(broom)
theme_set(theme_classic() +
          theme(axis.line.x = element_line(color = 'black'),
                axis.line.y = element_line(color = 'black'),
                text = element_text(size = 15)))
```

## Quick review of probability

This Venn diagram represents the event space for two events, $A$ and $B$. The area inside of the rectangle is 1.

\def\firstcircle{(0,0) circle (2cm)}
\def\secondcircle{(45:2.5cm) circle (2cm)}
\def\thirdcircle{(0:2.5cm) circle (2cm)}

\centering
\begin{tikzpicture}
    \draw (-3,-3) rectangle (5.5,2.5);
    \draw \firstcircle node {$A$};
    \draw \thirdcircle node {$B$};
\end{tikzpicture}

## Quick review of probability

This represents P($A$).

\def\firstcircle{(0,0) circle (2cm)}
\def\secondcircle{(45:2.5cm) circle (2cm)}
\def\thirdcircle{(0:2.5cm) circle (2cm)}

\centering
\begin{tikzpicture}
    % P(A)
    \begin{scope}
      \fill[yellow] \firstcircle;
    \end{scope}
    
    \draw (-3,-3) rectangle (5.5,2.5);
    \draw \firstcircle node {$A$};
    \draw \thirdcircle node {$B$};

\end{tikzpicture}

## Quick review of probability: Union

This represents P($A \cup B$).

\def\firstcircle{(0,0) circle (2cm)}
\def\secondcircle{(45:2.5cm) circle (2cm)}
\def\thirdcircle{(0:2.5cm) circle (2cm)}

\centering
\begin{tikzpicture}
    % P(A)
    \begin{scope}
      \fill[yellow] \firstcircle;
      \fill[yellow] \thirdcircle;
    \end{scope}
    
    \draw (-3,-3) rectangle (5.5,2.5);
    \draw \firstcircle node {$A$};
    \draw \thirdcircle node {$B$};

\end{tikzpicture}

## Quick review of probability: Intersection

This represents P($A \cap B$).

\def\firstcircle{(0,0) circle (2cm)}
\def\secondcircle{(45:2.5cm) circle (2cm)}
\def\thirdcircle{(0:2.5cm) circle (2cm)}

\centering
\begin{tikzpicture}
    % P(A)
    \begin{scope}
      \clip \firstcircle;
      \fill[yellow] \thirdcircle;
    \end{scope}
    
    \draw (-3,-3) rectangle (5.5,2.5);
    \draw \firstcircle node {$A$};
    \draw \thirdcircle node {$B$};

\end{tikzpicture}

## Quick review of probability: Practice

\small
\begin{multicols}{2}
$$
\begin{aligned}
\mbox{P}\left(!\left(A \cup B\right) \right) &= 0.59\\
\mbox{P}(A) &= 0.29 \\
\mbox{P}(A \cap !B) &= 0.23
\end{aligned}
$$
\\  \columnbreak
$$
\begin{aligned}
\mbox{P}(A\cap B) &= 0.06 \\
\mbox{P}(A|B) &= \frac{0.06}{0.18} = 0.33 \\
\mbox{P}(A|!B) &= \frac{0.23}{0.82} = 0.28
\end{aligned}
$$
\end{multicols}

\def\firstcircle{(0,0) circle (2.25cm)}
\def\secondcircle{(45:2.5cm) circle (2cm)}
\def\thirdcircle{(0:2.5cm) circle (1.75cm)}

\centering
\begin{tikzpicture}
    \draw (-3,-3) rectangle (5.5,2.5);
    \draw \firstcircle node {$\begin{array}{c} A\\ 0.23 \end{array}$};
    \draw \thirdcircle;
    \draw (2.8,0) node {$\begin{array}{c} B\\ 0.12 \end{array}$};
    \draw (1.7,0) node {0.06};
\end{tikzpicture}


## Definition: Odds of $D$ given $E$

\small
Given a disease outcome, $D$, an exposure, $E$, and

\begin{center}
\begin{tabular}{ r | c | c | c }
          &     $D = 1$     &    $D = 0$      &   row total     \\ \hline
  $E = 1$ &    $n_{1,1}$    &   $n_{1,0}$     & $n_{1,\bullet}$ \\
  $E = 0$ &    $n_{0,1}$    &   $n_{0,0}$     & $n_{0,\bullet}$ \\ \hline
col total & $n_{\bullet,1}$ & $n_{\bullet,0}$ & $N$
\end{tabular}
\end{center}

the odds of event $D$ given exposure are \vspace{-16pt}

\begin{multicols}{2}
$$
\begin{aligned}
\mbox{P}(D=1|E&=1) \\ 
                  &= \frac{\mbox{P}(D=1 \cap E=1)}{\mbox{P}(E=1)} \\
                  &= \left. \frac{n_{1,1}}{\cancel N} \middle/ 
                            \frac{n_{1,\bullet}}{\cancel N} \right. \\
                  &= \frac{n_{1,1}}{n_{1,\bullet}} \\
\end{aligned}
$$
\\ \columnbreak
$$
\begin{aligned}
\mbox{P}(D=0|E&=1) \\
                  &= \frac{\mbox{P}(D=0 \cap E=1)}{\mbox{P}(E=1)} \\
                  &= \left. \frac{n_{1,0}}{\cancel N} \middle/ 
                            \frac{n_{1,\bullet}}{\cancel N} \right. \\
                  &= \frac{n_{1,0}}{n_{1,\bullet}} \\[12pt]
\end{aligned}
$$
\end{multicols}


## Definition: Odds of $D$ given $E$

\small
Given a disease outcome, $D$, an exposure, $E$, and

\begin{center}
\begin{tabular}{ r | c | c | c }
          &     $D = 1$     &    $D = 0$      &   row total     \\ \hline
  $E = 1$ &    $n_{1,1}$    &   $n_{1,0}$     & $n_{1,\bullet}$ \\
  $E = 0$ &    $n_{0,1}$    &   $n_{0,0}$     & $n_{0,\bullet}$ \\ \hline
col total & $n_{\bullet,1}$ & $n_{\bullet,0}$ & $N$
\end{tabular}
\end{center}

the odds of event $D$ given exposure are

$$
\begin{aligned}
odds(D=1|E=1) &= \frac{\mbox{P}(D=1|E=1)}{\mbox{P}(D=0|E=1)} \\
              &= \left. \frac{n_{1,1}}{\cancel{n_{1,\bullet}}} \middle/ 
                        \frac{n_{1,0}}{\cancel{n_{1,\bullet}}}\right. \\
              &= \frac{n_{1,1}}{n_{1,0}}
\end{aligned}
$$


## Definition: Odds of $D$ given $!E$

\small
Given a disease outcome, $D$, an exposure, $E$, and

\begin{center}
\begin{tabular}{ r | c | c | c }
          &     $D = 1$     &    $D = 0$      &   row total     \\ \hline
  $E = 1$ &    $n_{1,1}$    &   $n_{1,0}$     & $n_{1,\bullet}$ \\
  $E = 0$ &    $n_{0,1}$    &   $n_{0,0}$     & $n_{0,\bullet}$ \\ \hline
col total & $n_{\bullet,1}$ & $n_{\bullet,0}$ & $N$
\end{tabular}
\end{center}

the odds of event $D$ given $no$ exposure are \vspace{-16pt}

\begin{multicols}{2}
$$
\begin{aligned}
\mbox{P}(D=1|E&=1) \\ 
                  &= \frac{\mbox{P}(D=1 \cap E=0)}{\mbox{P}(E=0)} \\
                  &= \left. \frac{n_{0,1}}{\cancel N} \middle/ 
                            \frac{n_{0,\bullet}}{\cancel N} \right. \\
                  &= \frac{n_{0,1}}{n_{0,\bullet}} \\
\end{aligned}
$$
\\ \columnbreak
$$
\begin{aligned}
\mbox{P}(D=0|E&=1) \\
                  &= \frac{\mbox{P}(D=0 \cap E=1)}{\mbox{P}(E=1)} \\
                  &= \left. \frac{n_{0,0}}{\cancel N} \middle/ 
                            \frac{n_{0,\bullet}}{\cancel N} \right. \\
                  &= \frac{n_{0,0}}{n_{0,\bullet}} \\[12pt]
\end{aligned}
$$
\end{multicols}

## Definition: Odds of $D$ given $!E$

\small
Given a disease outcome, $D$, an exposure, $E$, and

\begin{center}
\begin{tabular}{ r | c | c | c }
          &     $D = 1$     &    $D = 0$      &   row total     \\ \hline
  $E = 1$ &    $n_{1,1}$    &   $n_{1,0}$     & $n_{1,\bullet}$ \\
  $E = 0$ &    $n_{0,1}$    &   $n_{0,0}$     & $n_{0,\bullet}$ \\ \hline
col total & $n_{\bullet,1}$ & $n_{\bullet,0}$ & $N$
\end{tabular}
\end{center}

the odds of event $D$ given $no$ exposure are

$$
\begin{aligned}
odds(D=1|E=1) &= \frac{\mbox{P}(D=1|E=0)}{\mbox{P}(D=0|E=0)} \\
              &= \left. \frac{n_{0,1}}{\cancel{n_{0,\bullet}}} \middle/ 
                        \frac{n_{0,0}}{\cancel{n_{0,\bullet}}}\right. \\
              &= \frac{n_{0,1}}{n_{0,0}}
\end{aligned}
$$

## Definition: Odds Ratio

Given a disease outcome, $D$, an exposure, $E$, and

\begin{center}
\begin{tabular}{ r | c | c | c }
          &     $D = 1$     &    $D = 0$      &   row total     \\ \hline
  $E = 1$ &    $n_{1,1}$    &   $n_{1,0}$     & $n_{1,\bullet}$ \\
  $E = 0$ &    $n_{0,1}$    &   $n_{0,0}$     & $n_{0,\bullet}$ \\ \hline
col total & $n_{\bullet,1}$ & $n_{\bullet,0}$ & $N$
\end{tabular}
\end{center}

the ratio of the odds of disease comparing exposure vs no exposure is

$$
\begin{aligned}
OR(D|E) &= \frac{odds(D=1|E=1)}{odds(D=1|E=0)} \\
          &= \left. \frac{n_{1,1}}{n_{1,0}} \middle/
                    \frac{n_{0,1}}{n_{0,0}} \right. \\
          &= \frac{n_{1,1}n_{0,0}}{n_{1,0}n_{0,1}}.
\end{aligned}
$$

## Definition: $se(\log OR)$

Given a disease outcome, $D$, an exposure, $E$, and

\begin{center}
\begin{tabular}{ r | c | c | c }
          &     $D = 1$     &    $D = 0$      &   row total     \\ \hline
  $E = 1$ &    $n_{1,1}$    &   $n_{1,0}$     & $n_{1,\bullet}$ \\
  $E = 0$ &    $n_{0,1}$    &   $n_{0,0}$     & $n_{0,\bullet}$ \\ \hline
col total & $n_{\bullet,1}$ & $n_{\bullet,0}$ & $N$
\end{tabular}
\end{center}

the log OR is normally distributed, and its standard error is

$$ se(\log OR) = \sqrt{\frac{1}{n_{1,1}} + 
                       \frac{1}{n_{1,0}} + 
                       \frac{1}{n_{0,1}} + 
                       \frac{1}{n_{0,0}}}. $$

## Putting everything together

Given a disease outcome, $D$, and exposure, $E$, and

\begin{center}
\begin{tabular}{ r | c | c | c }
          & $D = 1$ & $D = 0$ & row total \\ \hline
  $E = 1$ &    36   &    54   & {\it 90}  \\
  $E = 0$ &    32   &    89   & {\it 121} \\ \hline
col total & {\it 68}&{\it 143}& {\it 211}
\end{tabular}
\end{center}

what is the OR and 95% CI for the exposure, $E$? Is this statistically significant?

$$
\begin{aligned}
      OR(D|E) &= \frac{36*89}{32*54} \\
              &= 1.85 \\
      \log OR &= 0.617 \\
se ( \log OR) &= \sqrt{\frac{1}{36} + \frac{1}{54} + \frac{1}{32} + \frac{1}{89}} \\
              &= 0.298
\end{aligned}
$$


## Putting everything together

Given a disease outcome, $D$, and exposure, $E$, and

\begin{center}
\begin{tabular}{ r | c | c | c }
          & $D = 1$ & $D = 0$ & row total \\ \hline
  $E = 1$ &    36   &    54   & {\it 90}  \\
  $E = 0$ &    32   &    89   & {\it 121} \\ \hline
col total & {\it 68}&{\it 143}& {\it 211}
\end{tabular}
\end{center}

what is the OR and 95% CI for the exposure, $E$? Is this statistically significant?

$$
\begin{aligned}
              OR &= 1.85 \\
95\%~CI(\log OR) &= 0.617 \pm 1.96*0.298 \\
                 &= (0.031, 1.199) \\
    95\%~CI (OR) &= (1.03, 3.32)
\end{aligned}
$$


## Logistic Regression: Review

\scriptsize
```{r glm code, echo = TRUE}
set.seed(934875)
n <- 100
dat <- data_frame(ts = runif(100, 0, 10), # tumor size
                  lodds = rnorm(n, (ts - 5)), # log odds of metastisis
                  odds = exp(lodds),
                  p = odds / (1 + odds),
                  metastasis = rbinom(n, 1, p))

model <- glm(metastasis ~ ts, data = dat, family = binomial)

lodds.g <- ggplot(dat, aes(ts, lodds)) +
           geom_point() +
           ylab("log Odds") +
           geom_abline(intercept = model[[1]][1], slope = model[[1]][2])

set.seed(29384)
p.g <- ggplot(dat, aes(ts, metastasis)) +
       geom_jitter(width = 0, height = .05) +
       geom_smooth(method = 'loess', se = FALSE, linetype = 2) +
       geom_line(data = arrange(augment(model), .fitted), 
                 aes(ts, exp(.fitted) / (1+exp(.fitted))))
```

## Logistic Regression: Review

```{r glm1}
lodds.g
```

## Logistic Regression: Review

```{r glm2}
p.g
```